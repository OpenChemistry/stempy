name: docker

on:
  push:
    branches:
      - "master"

jobs:
  # Builds base image for stempy of various verions if Dockerfile.base has changed
  build-base:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - version: stempy
            tag-suffix: -conda-jammy
          - version: stempy-mpi
            tag-suffix: -conda
          - version: stempy-mpi
            tag-suffix: -conda-jammy

    steps:
      -
        name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      -
        name: Determine if Dockerfile.base changed
        id: changed-dockerfile-base
        uses: tj-actions/changed-files@v35
        with:
          files: |
            docker/${{ matrix.version }}${{ matrix.tag-suffix}}/Dockerfile.base
      -
        name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      -
        name: Build/push Dockerfile.base
        uses: docker/build-push-action@v3
        if: ${{ contains(github.event.head_commit.message, 'trigger-ci') || steps.changed-dockerfile-base.outputs.any_changed == 'true'}}
        with:
          context: ./docker/${{ matrix.version }}${{ matrix.tag-suffix}}
          file: ./docker/${{ matrix.version }}${{ matrix.tag-suffix}}/Dockerfile.base
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.version }}-base:latest${{ matrix.tag-suffix }}
          cache-to: type=gha
          cache-from: type=gha,mode=max

# Builds stempy every time after build-base is done
  build-stempy:
    runs-on: ubuntu-latest
    needs: [build-base]
    strategy:
      matrix:
        include:
          - version: stempy
            tag-suffix: -conda-jammy
          - version: stempy
            tag-suffix: -conda-jammy
            notebook: -ipykernel
          - version: stempy-mpi
            tag-suffix: -conda
          - version: stempy-mpi
            tag-suffix: -conda-jammy

      fail-fast: false
    steps:
      -
        name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      -
        name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      -
        name: Build/push ${{ matrix.version }}${{matrix.notebook}}
        uses: docker/build-push-action@v3
        with:
          context: ./docker/${{ matrix.version }}${{ matrix.tag-suffix}}
          file: ./docker/${{ matrix.version }}${{ matrix.tag-suffix}}/Dockerfile.stempy${{matrix.notebook}}
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.version }}${{matrix.notebook}}:latest${{ matrix.tag-suffix}}

  # Seperate job for building original version
  build-stempy-old:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - version: stempy
            MPI: OFF
          - version: stempy-mpi
            MPI: ON
    steps:
      -
        name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      -
        name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - # Building base versions using original dockerfile
        name: Build/push ${{ matrix.version }}
        uses: docker/build-push-action@v3
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.version }}:latest
          build-args: |
                      MPI=${{ matrix.MPI }}
          cache-to: type=gha
          cache-from: type=gha, mode=max
      
      - # Building ipykernel
        name: Build/push ${{ matrix.version }}-ipykernel
        if: ${{ matrix.version == 'stempy' }}
        uses: docker/build-push-action@v3
        with:
          context: ./docker
          file: ./docker/Dockerfile.ipykernel
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.version }}-ipykernel:latest